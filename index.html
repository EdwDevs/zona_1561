<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>F1 Engineer: Cockpit View</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Inter:wght@400;800&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Inter', sans-serif;
            color: white;
            user-select: none;
        }

        #game-container {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1;
        }

        /* --- HALO HUD (Estilo TV F1) --- */
        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            background: radial-gradient(circle, transparent 60%, rgba(0,0,0,0.8) 100%); /* Vignette */
        }

        /* Top Halo Info */
        .halo-bar {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .halo-hud {
            background: rgba(16, 20, 30, 0.85);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #00f2ff;
            backdrop-filter: blur(5px);
            padding: 10px 30px;
            display: flex;
            gap: 40px;
            border-radius: 20px;
            clip-path: polygon(10% 0, 90% 0, 100% 100%, 0% 100%);
            transform: perspective(500px) rotateX(10deg);
        }

        .hud-item { text-align: center; }
        .hud-label { font-size: 0.7rem; color: #888; letter-spacing: 1px; }
        .hud-value { font-family: 'Share Tech Mono'; font-size: 1.8rem; font-weight: bold; text-shadow: 0 0 10px currentColor; }

        /* Radio Box (Interactivo) */
        #radio-panel {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 320px;
            pointer-events: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .comm-box {
            background: rgba(0, 0, 0, 0.7);
            border-left: 4px solid #00ff9d;
            padding: 15px;
            font-size: 0.9rem;
            color: #fff;
            animation: slideIn 0.3s ease-out;
            margin-bottom: 10px;
            font-family: 'Share Tech Mono';
        }
        
        .comm-driver { border-color: #ffcc00; } /* Amarillo para piloto */
        .comm-engineer { border-color: #00ff9d; text-align: right; }

        .comm-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
        }

        .radio-btn {
            background: rgba(0, 50, 80, 0.8);
            border: 1px solid #00f2ff;
            color: #00f2ff;
            padding: 12px;
            font-family: 'Share Tech Mono';
            font-size: 0.8rem;
            cursor: pointer;
            text-transform: uppercase;
            transition: all 0.2s;
        }
        
        .radio-btn:hover { background: #00f2ff; color: #000; }
        .radio-btn.urgent { border-color: #ff3366; color: #ff3366; }
        .radio-btn.urgent:hover { background: #ff3366; color: white; }

        @keyframes slideIn { from { opacity:0; transform: translateX(20px); } to { opacity:1; transform: translateX(0); } }

        /* Strategy Controls (Bottom) */
        .strategy-dock {
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 20px;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            pointer-events: auto;
        }

        .strat-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(255,255,255,0.05);
            padding: 5px 10px;
            border-radius: 8px;
        }

        .strat-title { font-size: 0.7rem; color: #aaa; margin-bottom: 5px; }
        
        .toggle-btn {
            background: #333;
            color: #fff;
            border: none;
            padding: 8px 15px;
            cursor: pointer;
            font-weight: bold;
            font-family: 'Share Tech Mono';
            min-width: 80px;
        }
        
        .toggle-btn.active { background: #00f2ff; color: #000; box-shadow: 0 0 15px #00f2ff; }
        .toggle-btn.danger.active { background: #ff3366; color: #fff; box-shadow: 0 0 15px #ff3366; }

        /* Overlay Start */
        #start-screen {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.95);
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
    </style>
</head>
<body>

    <!-- 3D Layer -->
    <div id="game-container"></div>

    <!-- UI Overlay -->
    <div id="ui-layer">
        <!-- Telemetry Halo -->
        <div class="halo-bar">
            <div class="halo-hud">
                <div class="hud-item">
                    <div class="hud-label">MARCHA</div>
                    <div class="hud-value" style="color: #ff3366" id="gear-val">3</div>
                </div>
                <div class="hud-item">
                    <div class="hud-label">RPM</div>
                    <div class="hud-value" style="color: #00f2ff" id="rpm-val">11200</div>
                </div>
                <div class="hud-item">
                    <div class="hud-label">DELTA</div>
                    <div class="hud-value" style="color: #00ff9d" id="delta-val">-0.420</div>
                </div>
                <div class="hud-item">
                    <div class="hud-label">NEUMÁTICOS</div>
                    <div class="hud-value" id="tire-val">98%</div>
                </div>
            </div>
        </div>

        <!-- Radio Comms Right -->
        <div id="radio-panel">
            <div id="messages-area">
                <!-- Mensajes dinámicos aquí -->
            </div>
            <div class="comm-options" id="radio-controls">
                <button class="radio-btn" onclick="sim.sendRadio('tires')">ESTADO RUEDAS</button>
                <button class="radio-btn" onclick="sim.sendRadio('gap')">DIFERENCIA</button>
                <button class="radio-btn" onclick="sim.sendRadio('encourage')">¡VAMOS!</button>
                <button class="radio-btn urgent" onclick="sim.sendRadio('box')">BOX BOX</button>
            </div>
        </div>

        <!-- Bottom Controls -->
        <div class="strategy-dock">
            <div class="strat-group">
                <div class="strat-title">MODO MOTOR</div>
                <div style="display:flex; gap:2px">
                    <button class="toggle-btn" id="mode-save" onclick="sim.setMode('SAVE')">AHORRO</button>
                    <button class="toggle-btn active" id="mode-normal" onclick="sim.setMode('NORMAL')">STD</button>
                    <button class="toggle-btn danger" id="mode-push" onclick="sim.setMode('PUSH')">MAX</button>
                </div>
            </div>
            <div class="strat-group">
                <div class="strat-title">ERS (BATERÍA)</div>
                <div style="display:flex; gap:2px">
                    <button class="toggle-btn active" id="ers-auto" onclick="sim.setERS('AUTO')">AUTO</button>
                    <button class="toggle-btn danger" id="ers-overtake" onclick="sim.setERS('OVERTAKE')">OVERTAKE</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Start Screen -->
    <div id="start-screen">
        <h1 style="font-size:3rem; color:#fff; font-family:'Russo One'">GP DE MONZA</h1>
        <p style="color:#aaa; max-width:500px">
            Estás en el muro de boxes. Tienes visión directa desde el casco de Alex.<br>
            Tu trabajo es gestionar su ritmo, la batería y la estrategia.<br>
            No conduzcas, <strong>toma decisiones</strong>.
        </p>
        <button class="radio-btn" style="font-size:1.5rem; padding:20px 40px; margin-top:20px;" onclick="sim.start()">CONECTAR RADIO</button>
    </div>

    <script>
        // --- CONFIGURACIÓN Y ESTADO ---
        const CONFIG = {
            trackRadius: 100,
            baseSpeed: 1.5,
            turnSpeed: 0.03
        };

        const STATE = {
            isPlaying: false,
            lap: 1,
            tireWear: 0, // 0 to 100
            fuel: 100,
            engineMode: 'NORMAL', // SAVE, NORMAL, PUSH
            ersMode: 'AUTO',
            battery: 100,
            position: 4,
            gapFront: 2.5,
            trackProgress: 0,
            lastMsgTime: 0,
            stressLevel: 0 // Nivel de estrés del piloto
        };

        // --- MOTOR 3D (Three.js) ---
        const container = document.getElementById('game-container');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB);
        scene.fog = new THREE.FogExp2(0x87CEEB, 0.008);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        container.appendChild(renderer.domElement);

        // Iluminación
        const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.8);
        scene.add(hemiLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 1);
        dirLight.position.set(50, 100, 50);
        dirLight.castShadow = true;
        scene.add(dirLight);

        // --- ASSETS ---
        // Generar Pista Procedural
        function createTrack() {
            const points = [];
            for (let i = 0; i <= 100; i++) {
                const t = (i / 100) * Math.PI * 2;
                // Forma de circuito compleja
                const x = Math.cos(t) * CONFIG.trackRadius + Math.sin(t * 3) * 30;
                const z = Math.sin(t) * CONFIG.trackRadius + Math.cos(t * 2) * 20;
                points.push(new THREE.Vector3(x, 0, z));
            }
            const curve = new THREE.CatmullRomCurve3(points);
            curve.closed = true;
            
            const trackGeo = new THREE.TubeGeometry(curve, 200, 8, 4, true); // Ancho de pista
            // Aplanar tubo para carretera
            const pos = trackGeo.attributes.position;
            for(let i=0; i<pos.count; i++) pos.setY(i, pos.getY(i) * 0.1);
            trackGeo.computeVertexNormals();

            const mat = new THREE.MeshStandardMaterial({ color: 0x333333, roughness: 0.8 });
            const mesh = new THREE.Mesh(trackGeo, mat);
            mesh.receiveShadow = true;
            scene.add(mesh);

            // Suelo
            const ground = new THREE.Mesh(
                new THREE.PlaneGeometry(1000, 1000),
                new THREE.MeshStandardMaterial({ color: 0x2d4c1e })
            );
            ground.rotation.x = -Math.PI/2;
            ground.position.y = -0.1;
            scene.add(ground);

            // Objetos Entorno (Árboles simples)
            for(let i=0; i<50; i++) {
                const t = Math.random();
                const pt = curve.getPoint(t);
                const offset = new THREE.Vector3(Math.random()-0.5, 0, Math.random()-0.5).normalize().multiplyScalar(15 + Math.random()*20);
                const treePos = pt.add(offset);
                
                const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.5,0.5,2), new THREE.MeshStandardMaterial({color:0x5c4033}));
                trunk.position.set(treePos.x, 1, treePos.z);
                const leaves = new THREE.Mesh(new THREE.ConeGeometry(3,6), new THREE.MeshStandardMaterial({color:0x0f5c0f}));
                leaves.position.set(treePos.x, 4, treePos.z);
                scene.add(trunk); scene.add(leaves);
            }

            return curve;
        }

        const trackCurve = createTrack();

        // Coche del Jugador (Invisible, solo punto de anclaje de cámara y morro)
        const carGroup = new THREE.Group();
        scene.add(carGroup);

        // Morro del coche (Visible para referencia)
        const noseGeo = new THREE.BoxGeometry(1, 0.5, 2.5);
        const noseMat = new THREE.MeshStandardMaterial({ color: 0xff0000, roughness: 0.4 });
        const nose = new THREE.Mesh(noseGeo, noseMat);
        nose.position.set(0, 0.5, -1.5);
        carGroup.add(nose);
        
        // Ruedas delanteras (Para sensación de velocidad)
        const wheelGeo = new THREE.CylinderGeometry(0.4, 0.4, 0.5, 16);
        wheelGeo.rotateZ(Math.PI/2);
        const wheelMat = new THREE.MeshBasicMaterial({color:0x111});
        const wL = new THREE.Mesh(wheelGeo, wheelMat); wL.position.set(-1, 0.4, -2.5);
        const wR = new THREE.Mesh(wheelGeo, wheelMat); wR.position.set(1, 0.4, -2.5);
        carGroup.add(wL); carGroup.add(wR);

        // --- LÓGICA DEL JUEGO (SIMULACIÓN) ---
        const sim = {
            start() {
                document.getElementById('start-screen').style.display = 'none';
                STATE.isPlaying = true;
                this.addMessage("engineer", "Radio check. Carrera en verde. Mantén temperatura en los neumáticos.");
                setTimeout(() => this.addMessage("driver", "Recibido. El coche se siente un poco pesado."), 2000);
            },

            updateLogic() {
                if(!STATE.isPlaying) return;

                // 1. Calcular Velocidad basada en decisiones
                let currentSpeed = CONFIG.baseSpeed;
                
                if (STATE.engineMode === 'PUSH') currentSpeed *= 1.15;
                if (STATE.engineMode === 'SAVE') currentSpeed *= 0.9;
                if (STATE.ersMode === 'OVERTAKE' && STATE.battery > 0) {
                    currentSpeed *= 1.2;
                    STATE.battery -= 0.5;
                } else if (STATE.battery < 100) {
                    STATE.battery += 0.1; // Recarga pasiva
                }

                // Desgaste de neumáticos
                let wearRate = 0.03;
                if (STATE.engineMode === 'PUSH') wearRate *= 1.5;
                STATE.tireWear += wearRate;

                // Degradación de rendimiento por neumáticos
                if (STATE.tireWear > 70) currentSpeed *= 0.8;

                // Mover Coche en la curva
                STATE.trackProgress += currentSpeed * 0.0005;
                if (STATE.trackProgress > 1) STATE.trackProgress = 0;

                const pt = trackCurve.getPointAt(STATE.trackProgress);
                const tangent = trackCurve.getTangentAt(STATE.trackProgress);
                
                // Actualizar posición 3D
                carGroup.position.copy(pt);
                // Mirar hacia adelante
                const lookAtPt = trackCurve.getPointAt((STATE.trackProgress + 0.01) % 1);
                carGroup.lookAt(lookAtPt);

                // Cámara: Posición "Casco"
                // Un poco arriba y atrás del centro del coche, con vibración
                const shake = (currentSpeed / 2) * 0.05;
                camera.position.copy(carGroup.position).add(new THREE.Vector3(0, 1.2 + (Math.random()*shake), 0));
                
                // La cámara mira un punto lejano adelante
                const camTarget = trackCurve.getPointAt((STATE.trackProgress + 0.05) % 1);
                camera.lookAt(camTarget);

                // Actualizar UI
                this.updateUI(currentSpeed);
                this.checkRandomEvents();
            },

            updateUI(speed) {
                // RPM Falsas basadas en velocidad
                const rpm = Math.floor(10000 + (speed * 1000) + (Math.random() * 200));
                document.getElementById('rpm-val').innerText = rpm;
                
                // Neumáticos
                const tireHealth = 100 - Math.floor(STATE.tireWear);
                const tireEl = document.getElementById('tire-val');
                tireEl.innerText = tireHealth + '%';
                if(tireHealth < 40) tireEl.style.color = 'red';
                else tireEl.style.color = 'white';

                // Batería visual (borde del halo o algo, simplificado aquí en botones)
                const ersBtn = document.getElementById('ers-overtake');
                if(STATE.battery < 10) {
                    ersBtn.style.opacity = 0.5;
                    ersBtn.innerText = "NO BATT";
                } else {
                    ersBtn.style.opacity = 1;
                    ersBtn.innerText = `OVERTAKE (${Math.floor(STATE.battery)}%)`;
                }
            },

            setMode(mode) {
                STATE.engineMode = mode;
                // Update buttons visual
                ['save', 'normal', 'push'].forEach(m => {
                    const btn = document.getElementById(`mode-${m}`);
                    if(m === mode.toLowerCase()) btn.classList.add('active');
                    else btn.classList.remove('active');
                });
                
                // Feedback piloto
                if(mode === 'PUSH') this.addMessage("engineer", "Modo Ataque. ¡Empuja ahora!");
                if(mode === 'SAVE') this.addMessage("engineer", "Enfría el coche. Lift and coast.");
            },

            setERS(mode) {
                if(STATE.battery < 10 && mode === 'OVERTAKE') return;
                STATE.ersMode = mode;
                document.getElementById('ers-auto').classList.toggle('active', mode === 'AUTO');
                document.getElementById('ers-overtake').classList.toggle('active', mode === 'OVERTAKE');
            },

            // --- SISTEMA DE RADIO ---
            messagesArea: document.getElementById('messages-area'),

            addMessage(who, text) {
                const el = document.createElement('div');
                el.className = `comm-box comm-${who}`;
                el.innerText = (who === 'driver' ? "ALEX: " : "INGENIERO: ") + text;
                this.messagesArea.appendChild(el);
                
                // Auto scroll y limpieza
                if(this.messagesArea.children.length > 4) {
                    this.messagesArea.removeChild(this.messagesArea.children[0]);
                }
            },

            sendRadio(type) {
                if(type === 'tires') {
                    this.addMessage("engineer", "¿Cómo están los neumáticos?");
                    setTimeout(() => {
                        if(STATE.tireWear > 60) this.addMessage("driver", "¡Se están muriendo! ¡Patinan mucho!");
                        else if(STATE.tireWear > 30) this.addMessage("driver", "Empiezan a caer, pero aguantan.");
                        else this.addMessage("driver", "Los neumáticos están perfectos.");
                    }, 1500);
                }
                if(type === 'gap') {
                    this.addMessage("engineer", "Diferencia con el de adelante.");
                    setTimeout(() => {
                        this.addMessage("driver", `Lo veo a ${STATE.gapFront} segundos. ¿Puedo empujar?`);
                    }, 1500);
                }
                if(type === 'encourage') {
                    this.addMessage("engineer", "Buen ritmo, sigue así. Cabeza abajo.");
                    STATE.stressLevel = Math.max(0, STATE.stressLevel - 10);
                }
                if(type === 'box') {
                    this.addMessage("engineer", "BOX, BOX, BOX. En esta vuelta.");
                    setTimeout(() => {
                        this.addMessage("driver", "Copiado. Box esta vuelta.");
                        // Resetear neumáticos tras un delay
                        setTimeout(() => {
                            STATE.tireWear = 0;
                            this.addMessage("engineer", "Buena parada. 2.4 segundos. Vamos.");
                        }, 5000);
                    }, 1000);
                }
            },

            checkRandomEvents() {
                const now = Date.now();
                if (now - STATE.lastMsgTime < 8000) return; // Evitar spam

                if (Math.random() < 0.005) {
                    // Evento aleatorio
                    const msgs = [
                        "Siento vibraciones en el freno delantero.",
                        "El de atrás se acerca muy rápido en las rectas.",
                        "¿Cuál es mi tiempo delta?",
                        "Bandera azul, quítamelo de encima."
                    ];
                    const msg = msgs[Math.floor(Math.random() * msgs.length)];
                    this.addMessage("driver", msg);
                    STATE.lastMsgTime = now;
                }
            }
        };

        // --- BUCLE PRINCIPAL ---
        function animate() {
            requestAnimationFrame(animate);
            sim.updateLogic();
            renderer.render(scene, camera);
        }

        // Resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        animate();

    </script>
</body>
</html>
